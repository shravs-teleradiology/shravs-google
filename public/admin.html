<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Shravs Teleradiology</title>
  <style>
    *{ margin:0; padding:0; box-sizing:border-box; }
    body{ font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; background:#000; color:#fff; }

    .header{
      background:linear-gradient(135deg,#0a0a0a,#1a1a1a);
      border-bottom:2px solid #0ea5e9;
      padding:18px 22px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .header-left{ display:flex; align-items:center; gap:14px; }
    .logo{ width:58px; height:58px; border-radius:50%; border:2px solid #fff; object-fit:cover; }
    .header h1{ font-size:1.2em; text-transform:uppercase; letter-spacing:1.5px; }

    .header-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chat-btn{
      padding:10px 14px; border-radius:18px;
      background:linear-gradient(135deg,#0ea5e9,#06b6d4);
      color:#fff; border:none;
      font-weight:900; text-transform:uppercase; letter-spacing:0.6px;
      cursor:pointer;
    }
    .chat-btn:hover{ filter:brightness(1.08); }
    .logout-btn{
      padding:10px 18px; border-radius:20px;
      background:transparent; border:2px solid #ff6b6b; color:#ff6b6b;
      cursor:pointer; font-weight:900; text-transform:uppercase; letter-spacing:0.8px;
    }
    .logout-btn:hover{ background:#ff6b6b; color:#000; }

    .container{ max-width:1400px; margin:0 auto; padding:22px 16px 40px; }

    .stats{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px; margin-bottom:18px;
    }
    .stat{
      background:linear-gradient(135deg,#0a0a0a,#1a1a1a);
      border:2px solid #0ea5e9; border-radius:14px;
      padding:18px; text-align:center;
    }
    .stat .num{ font-size:2.4em; font-weight:900; color:#0ea5e9; }
    .stat .lbl{ color:#999; text-transform:uppercase; letter-spacing:1px; font-size:0.85em; }

    .section{
      background:#0a0a0a;
      border:2px solid #333; border-radius:14px;
      padding:18px; margin-bottom:14px;
    }
    .section-header{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:2px solid #222; padding-bottom:10px; margin-bottom:12px;
      flex-wrap:wrap;
    }
    .section-title{
      color:#0ea5e9; font-size:1.1em; font-weight:900;
      text-transform:uppercase; letter-spacing:1px;
    }
    .search{
      width:320px; max-width:100%;
      padding:10px 12px; border-radius:18px;
      border:1px solid #333; background:#000; color:#fff;
    }
    .search:focus{ outline:none; border-color:#0ea5e9; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 920px){ .grid2{ grid-template-columns:1fr; } }

    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 700px){ .form-row{ grid-template-columns:1fr; } }
    label{
      display:block; margin-bottom:6px; font-size:0.8em; color:#ddd;
      text-transform:uppercase; letter-spacing:0.6px; font-weight:800;
    }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      background:#000; color:#fff; border:1px solid #333;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:#0ea5e9; }

    .btn{
      padding:10px 14px; border-radius:18px; cursor:pointer;
      font-weight:900; text-transform:uppercase; letter-spacing:0.6px;
      border:1px solid #0ea5e9; background:#0ea5e9; color:#000;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn-danger{ border-color:#ef4444; background:#ef4444; color:#fff; }
    .btn-ghost{ background:transparent; color:#0ea5e9; }
    .btn-ghost:hover{ background:#0ea5e9; color:#000; }

    table{ width:100%; border-collapse:collapse; }
    th{
      text-align:left; color:#0ea5e9;
      padding:12px 10px; border-bottom:2px solid #0ea5e9;
      font-size:0.85em; text-transform:uppercase; letter-spacing:0.8px;
    }
    td{
      padding:12px 10px; border-bottom:1px solid #222; color:#ddd;
      vertical-align:top; font-size:0.92em;
    }
    tr:hover{ background:rgba(14,165,233,0.05); }

    .pill{
      display:inline-block; padding:4px 10px; border-radius:15px;
      font-size:0.78em; font-weight:900; text-transform:uppercase;
    }
    .pill.priority-high{ background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid #ef4444; }
    .pill.priority-medium{ background:rgba(245,158,11,0.2); color:#f59e0b; border:1px solid #f59e0b; }
    .pill.priority-low{ background:rgba(34,197,94,0.2); color:#22c55e; border:1px solid #22c55e; }
    .pill.pending{ background:rgba(251,191,36,0.2); color:#fbba24; border:1px solid #fbba24; }
    .pill.done{ background:rgba(74,222,128,0.2); color:#4ade80; border:1px solid #4ade80; }

    .muted{ color:#888; font-size:0.9em; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* ===== Chat overlay (admin common chat only) ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.75);
      display:none;
      z-index:50;
    }
    .overlay.show{ display:block; }

    .chat-shell{
      position:absolute;
      right:14px; top:14px; bottom:14px;
      width:min(980px, calc(100vw - 28px));
      background:#050505;
      border:2px solid #0ea5e9;
      border-radius:14px;
      overflow:hidden;
      display:flex; flex-direction:column;
      box-shadow:0 18px 70px rgba(14,165,233,0.25);
    }
    .chat-top{
      padding:12px;
      border-bottom:1px solid #1c1c1c;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .chat-room{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.8px;
      font-size:0.92em;
      color:#0ea5e9;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chat-close{
      padding:8px 12px; border-radius:999px;
      border:1px solid #ff6b6b; background:transparent; color:#ff6b6b;
      cursor:pointer; font-weight:900; text-transform:uppercase; letter-spacing:0.6px; font-size:0.75em;
    }
    .chat-close:hover{ background:#ff6b6b; color:#000; }

    .messages{
      flex:1;
      padding:12px;
      overflow:auto;
    }
    .msg{
      border:1px solid #1f1f1f;
      background:#101010;
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .msg-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:6px;
    }
    .msg-author{ color:#0ea5e9; font-weight:900; font-size:0.9em; }
    .msg-time{ color:#777; font-size:0.75em; }
    .msg-text{ color:#ddd; white-space:pre-wrap; font-size:0.95em; }
    .attach{ margin-top:6px; font-size:0.85em; }
    .attach a{ color:#22c55e; text-decoration:none; }
    .attach a:hover{ text-decoration:underline; }

    .composer{
      border-top:1px solid #1c1c1c;
      background:#0a0a0a;
      padding:10px 12px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .composer.drag-over{ background:#04151f; border-top-color:#0ea5e9; }
    .composer-top{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .file-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px dashed #444;
      color:#aaa;
      cursor:pointer;
      user-select:none;
      font-size:0.8em;
      font-weight:800;
    }
    .file-name{ color:#ccc; font-size:0.8em; }
    .note{ width:100%; color:#777; font-size:0.75em; }
    .composer-bottom{ display:flex; gap:10px; }
    .composer textarea{
      flex:1;
      min-height:44px; max-height:110px;
      resize:none;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid #333;
      background:#000;
      color:#fff;
      font-size:0.95em;
    }
    .composer textarea:focus{ outline:none; border-color:#0ea5e9; }
    .send{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid #0ea5e9;
      background:linear-gradient(135deg,#0ea5e9,#06b6d4);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:0.7px;
      font-size:0.82em;
    }
    .send:hover{ filter:brightness(1.08); }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <img class="logo" src="https://i.ibb.co/FL6BLkS/P-Untitled-design.png" alt="Logo"/>
      <h1>Admin Dashboard</h1>
    </div>
    <div class="header-actions">
      <button class="chat-btn" onclick="openChat()">Chat</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="stats">
      <div class="stat"><div class="num" id="statUsers">0</div><div class="lbl">Total Users</div></div>
      <div class="stat"><div class="num" id="statEmployees">0</div><div class="lbl">Employees</div></div>
      <div class="stat"><div class="num" id="statTasks">0</div><div class="lbl">Total Tasks</div></div>
      <div class="stat"><div class="num" id="statPending">0</div><div class="lbl">Pending Tasks</div></div>
    </div>

    <div class="grid2">
      <!-- Employee Management -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Create Employee</div>
        </div>

        <div class="form-row">
          <div>
            <label for="empName">Name</label>
            <input id="empName" placeholder="Employee name"/>
          </div>
          <div>
            <label for="empEmail">Email</label>
            <input id="empEmail" type="email" placeholder="employee@example.com"/>
          </div>
          <div>
            <label for="empOrg">Department/Location</label>
            <input id="empOrg" placeholder="Department or location"/>
          </div>
          <div>
            <label for="empPassword">Password</label>
            <input id="empPassword" placeholder="Set password"/>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="createEmployee()">Create Employee</button>
          <div class="muted" style="margin-top:8px;">Employees cannot sign up from login page.</div>
        </div>
      </div>

      <!-- Assign Work -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Assign Work</div>
        </div>

        <div class="form-row">
          <div>
            <label for="taskAssignee">Assign to (Employee/Admin)</label>
            <select id="taskAssignee"></select>
          </div>
          <div>
            <label for="taskPriority">Priority</label>
            <select id="taskPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label for="taskDue">Due date</label>
            <input id="taskDue" type="date"/>
          </div>
          <div style="grid-column:1/-1;">
            <label for="taskTitle">Title</label>
            <input id="taskTitle" placeholder="Work title"/>
          </div>
          <div style="grid-column:1/-1;">
            <label for="taskDesc">Description</label>
            <textarea id="taskDesc" placeholder="Work details..."></textarea>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="assignTask()">Assign Task</button>
          <div class="muted" style="margin-top:8px;">Assigned staff see tasks immediately after login.</div>
        </div>
      </div>
    </div>

    <!-- Staff List -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Employees / Admins</div>
        <input class="search" id="empSearch" placeholder="Search..." oninput="renderStaff()"/>
      </div>
      <div id="staffTable"></div>
    </div>

    <!-- Tasks -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Assigned Works</div>
        <input class="search" id="taskSearch" placeholder="Search tasks..." oninput="renderTasks()"/>
      </div>
      <div id="tasksTable"></div>
    </div>
  </div>

  <!-- Chat overlay: common chat only -->
  <div class="overlay" id="chatOverlay" aria-hidden="true">
    <div class="chat-shell">
      <div class="chat-top">
        <div class="chat-room" id="roomTitle"># common</div>
        <button class="chat-close" onclick="closeChat()">Close</button>
      </div>

      <div class="messages" id="chatMessages"></div>

      <div class="composer" id="composerDropZone">
        <div class="composer-top">
          <label class="file-pill">
            Attach
            <input id="chatFile" type="file" style="display:none"
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt"/>
            <span class="file-name" id="fileName">No file</span>
          </label>
          <div class="note" id="chatNote"></div>
        </div>
        <div class="composer-bottom">
          <textarea id="chatText" placeholder="Type message..."></textarea>
          <button class="send" onclick="sendCommon()">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== AUTH: allow master admin (isAdmin=true) or promoted staff admin (currentUser.role=admin) =====
  const isAdminSession = sessionStorage.getItem("isAdmin") === "true";
  const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || "null");
  const isPromotedAdmin = currentUser && currentUser.role === "admin";

  if (!isAdminSession && !isPromotedAdmin) {
    alert("Unauthorized access. Please login as admin.");
    window.location.href = "login.html";
  }

  // Who is chatting / acting as admin
  const me = currentUser || { name:"Admin", email:"admin@shravsteleradiology.com", role:"admin" };

  const TASKS_KEY = "tasks_v1";
  const COMMON_KEY = "commonChatMessages_v1";

  const MAX_FILE_MB = 3;
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  let chatOpen = false;
  let pendingFile = null;

  function readJson(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || "null") ?? fallback; }
    catch { return fallback; }
  }
  function writeJson(key, value){
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (e) {
      alert("Storage full. Please delete old messages/tasks or use smaller files.");
      return false;
    }
  }
  function escapeHtml(text){
    return String(text ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function prettyTime(iso){
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  function logout(){
    if (!confirm("Logout?")) return;
    sessionStorage.clear();
    window.location.href = "login.html";
  }

  function getUsers(){ return readJson("users", []); }
  function saveUsers(users){ writeJson("users", users); }

  function getStaff(){
    // staff = employees + promoted admins (stored in users[])
    return getUsers().filter(u => u.role === "employee" || u.role === "admin");
  }

  function getEmployees(){
    return getUsers().filter(u => u.role === "employee");
  }

  function makeId(){
    return "t_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function getTasks(){ return readJson(TASKS_KEY, []); }
  function saveTasks(tasks){ writeJson(TASKS_KEY, tasks); }

  function refreshStats(){
    const users = getUsers();
    const employees = users.filter(u => u.role === "employee");
    const tasks = getTasks();
    const pending = tasks.filter(t => t.status === "pending").length;

    document.getElementById("statUsers").textContent = users.length;
    document.getElementById("statEmployees").textContent = employees.length;
    document.getElementById("statTasks").textContent = tasks.length;
    document.getElementById("statPending").textContent = pending;
  }

  function createEmployee(){
    const name = document.getElementById("empName").value.trim();
    const email = document.getElementById("empEmail").value.trim();
    const org = document.getElementById("empOrg").value.trim();
    const pw = document.getElementById("empPassword").value.trim();

    if (!name || !email || !pw) { alert("Name, email, password required."); return; }

    const users = getUsers();
    if (users.some(u => u.email === email)) { alert("Email already exists."); return; }

    users.push({
      name, email, phone:"", organization:org, role:"employee",
      password:pw, createdAt:new Date().toISOString()
    });
    saveUsers(users);

    document.getElementById("empName").value = "";
    document.getElementById("empEmail").value = "";
    document.getElementById("empOrg").value = "";
    document.getElementById("empPassword").value = "";

    alert("Employee created successfully.");
    populateAssigneeDropdown();
    renderStaff();
    refreshStats();
  }

  function promoteDemote(email){
    const users = getUsers();
    const u = users.find(x => x.email === email);
    if (!u) return;

    if (u.role === "employee") {
      if (!confirm(`Promote ${u.name} to Admin?`)) return;
      u.role = "admin";
    } else if (u.role === "admin") {
      if (!confirm(`Demote ${u.name} to Employee?`)) return;
      u.role = "employee";
    }
    saveUsers(users);
    populateAssigneeDropdown();
    renderStaff();
    refreshStats();
    alert("Updated successfully.");
  }

  function populateAssigneeDropdown(){
    const sel = document.getElementById("taskAssignee");
    const staff = getStaff();
    if (!staff.length) {
      sel.innerHTML = `<option value="">No staff found</option>`;
      return;
    }
    sel.innerHTML = `<option value="">-- Select staff --</option>` +
      staff.map(s => `<option value="${escapeHtml(s.email)}">${escapeHtml(s.name)} (${escapeHtml(s.role)})</option>`).join("");
  }

  function assignTask(){
    const assigneeEmail = document.getElementById("taskAssignee").value;
    const priority = document.getElementById("taskPriority").value;
    const due = document.getElementById("taskDue").value;
    const title = document.getElementById("taskTitle").value.trim();
    const desc = document.getElementById("taskDesc").value.trim();

    if (!assigneeEmail || !title) { alert("Assignee and title are required."); return; }

    const staff = getStaff();
    const person = staff.find(e => e.email === assigneeEmail);
    if (!person) { alert("Selected assignee is not staff."); return; }

    const tasks = getTasks();
    tasks.push({
      id: makeId(),
      title,
      description: desc,
      priority, // high | medium | low
      assignedToEmail: person.email,
      assignedToName: person.name,
      dueDate: due || "",
      status: "pending",
      createdAt: new Date().toISOString(),
      createdBy: me.email
    });
    saveTasks(tasks);

    document.getElementById("taskTitle").value = "";
    document.getElementById("taskDesc").value = "";
    document.getElementById("taskDue").value = "";

    alert("Task assigned successfully.");
    renderTasks();
    refreshStats();
  }

  function toggleTaskStatus(taskId){
    const tasks = getTasks();
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;
    t.status = (t.status === "pending") ? "done" : "pending";
    saveTasks(tasks);
    renderTasks();
    refreshStats();
  }

  function deleteTask(taskId){
    if (!confirm("Delete this task?")) return;
    const tasks = getTasks().filter(t => t.id !== taskId);
    saveTasks(tasks);
    renderTasks();
    refreshStats();
  }

  function renderStaff(){
    const q = (document.getElementById("empSearch").value || "").toLowerCase();
    const staff = getStaff().filter(s =>
      (s.name || "").toLowerCase().includes(q) ||
      (s.email || "").toLowerCase().includes(q) ||
      (s.organization || "").toLowerCase().includes(q) ||
      (s.role || "").toLowerCase().includes(q)
    );

    const box = document.getElementById("staffTable");
    if (!staff.length) {
      box.innerHTML = `<div class="muted">No staff found.</div>`;
      return;
    }

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Role</th><th>Department</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${staff.map(s => `
            <tr>
              <td>${escapeHtml(s.name)}</td>
              <td>${escapeHtml(s.email)}</td>
              <td><span class="pill">${escapeHtml(s.role)}</span></td>
              <td>${escapeHtml(s.organization || "-")}</td>
              <td>
                <div class="actions">
                  <button class="btn btn-ghost" onclick="promoteDemote('${escapeHtml(s.email)}')">
                    ${s.role === "admin" ? "Demote" : "Promote to admin"}
                  </button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderTasks(){
    const q = (document.getElementById("taskSearch").value || "").toLowerCase();
    let tasks = getTasks();

    tasks = tasks.filter(t =>
      (t.title || "").toLowerCase().includes(q) ||
      (t.description || "").toLowerCase().includes(q) ||
      (t.assignedToName || "").toLowerCase().includes(q) ||
      (t.assignedToEmail || "").toLowerCase().includes(q) ||
      (t.priority || "").toLowerCase().includes(q) ||
      (t.status || "").toLowerCase().includes(q)
    );

    tasks.sort((a,b) => {
      const prio = {high:3, medium:2, low:1};
      const aPrio = prio[a.priority || "low"] || 1;
      const bPrio = prio[b.priority || "low"] || 1;
      if (aPrio !== bPrio) return bPrio - aPrio;
      return new Date(b.createdAt) - new Date(a.createdAt);
    });

    const box = document.getElementById("tasksTable");
    if (!tasks.length) {
      box.innerHTML = `<div class="muted">No tasks assigned.</div>`;
      return;
    }

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Priority</th><th>Status</th><th>Title</th><th>Assigned To</th><th>Due</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${tasks.map(t => `
            <tr>
              <td><span class="pill priority-${escapeHtml(t.priority || 'low')}">${escapeHtml(t.priority || 'low')}</span></td>
              <td><span class="pill ${escapeHtml(t.status)}">${escapeHtml(t.status)}</span></td>
              <td>
                <div style="font-weight:900;">${escapeHtml(t.title)}</div>
                <div class="muted" style="margin-top:4px; white-space:pre-wrap;">${escapeHtml(t.description || "")}</div>
                <div class="muted" style="margin-top:4px;">Created: ${prettyTime(t.createdAt || "")}</div>
              </td>
              <td>${escapeHtml(t.assignedToName)}<div class="muted">${escapeHtml(t.assignedToEmail)}</div></td>
              <td>${t.dueDate ? escapeHtml(t.dueDate) : "-"}</td>
              <td>
                <div class="actions">
                  <button class="btn btn-ghost" onclick="toggleTaskStatus('${escapeHtml(t.id)}')">
                    ${t.status === "pending" ? "Mark done" : "Mark pending"}
                  </button>
                  <button class="btn btn-danger" onclick="deleteTask('${escapeHtml(t.id)}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // ===== Admin Chat (common only) =====
  function openChat(){
    chatOpen = true;
    const ov = document.getElementById("chatOverlay");
    ov.classList.add("show");
    ov.setAttribute("aria-hidden", "false");
    renderCommon();
  }

  function closeChat(){
    chatOpen = false;
    const ov = document.getElementById("chatOverlay");
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden", "true");
  }

  function getCommonMessages(){
    return readJson(COMMON_KEY, []);
  }

  function saveCommonMessages(list){
    return writeJson(COMMON_KEY, list);
  }

  function renderCommon(){
    const box = document.getElementById("chatMessages");
    const list = getCommonMessages();

    if (!list.length) {
      box.innerHTML = `<div class="muted" style="padding:14px; text-align:center;">No messages yet.</div>`;
      return;
    }

    list.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

    let html = "";
    for (const msg of list) {
      html += `
        <div class="msg">
          <div class="msg-head">
            <div class="msg-author">${escapeHtml(msg.authorName || "User")} <span style="color:#777;">(${escapeHtml(msg.authorRole || "")})</span></div>
            <div class="msg-time">${prettyTime(msg.timestamp || "")}</div>
          </div>
          <div class="msg-text">${escapeHtml(msg.text || "")}</div>
      `;

      if (msg.attachment && msg.attachment.dataUrl && msg.attachment.name) {
        html += `
          <div class="attach">
            <a href="${msg.attachment.dataUrl}" download="${escapeHtml(msg.attachment.name)}" target="_blank">
              ${escapeHtml(msg.attachment.name)}
            </a>
          </div>
        `;
      }

      html += `</div>`;
    }

    box.innerHTML = html;
    box.scrollTop = box.scrollHeight;
  }

  function clearPendingFile(){
    pendingFile = null;
    document.getElementById("chatFile").value = "";
    document.getElementById("fileName").textContent = "No file";
  }

  function handleSelectedFile(file){
    if (!file) return clearPendingFile();
    if (file.size > MAX_FILE_BYTES) {
      alert(`File too large. Max ${MAX_FILE_MB} MB.`);
      return clearPendingFile();
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingFile = {
        name: file.name,
        type: file.type,
        size: file.size,
        dataUrl: e.target.result
      };
    };
    reader.readAsDataURL(file);
    document.getElementById("fileName").textContent = file.name;
  }

  function sendCommon(){
    const textEl = document.getElementById("chatText");
    const text = (textEl.value || "").trim();
    if (!text && !pendingFile) return;

    const list = getCommonMessages();
    list.push({
      authorEmail: me.email,
      authorName: me.name,
      authorRole: me.role,
      text,
      timestamp: new Date().toISOString(),
      attachment: pendingFile
    });

    const ok = saveCommonMessages(list);
    if (!ok) return;

    textEl.value = "";
    clearPendingFile();
    renderCommon();
  }

  function setupDropZone(){
    const zone = document.getElementById("composerDropZone");
    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };

    ["dragenter","dragover","dragleave","drop"].forEach(evt => zone.addEventListener(evt, prevent, false));
    ["dragenter","dragover"].forEach(evt => zone.addEventListener(evt, () => zone.classList.add("drag-over"), false));
    ["dragleave","drop"].forEach(evt => zone.addEventListener(evt, () => zone.classList.remove("drag-over"), false));

    zone.addEventListener("drop", (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleSelectedFile(f);
    }, false);
  }

  window.addEventListener("load", () => {
    document.getElementById("chatNote").textContent = `Common chat only. Max file ${MAX_FILE_MB} MB.`;

    populateAssigneeDropdown();
    renderStaff();
    renderTasks();
    refreshStats();

    setupDropZone();
    document.getElementById("chatFile").addEventListener("change", function () {
      handleSelectedFile(this.files[0]);
    });

    document.getElementById("chatOverlay").addEventListener("click", (e) => {
      if (e.target.id === "chatOverlay") closeChat();
    });

    setInterval(() => {
      renderTasks();
      refreshStats();
      if (chatOpen) renderCommon();
    }, 5000);
  });
</script>
</body>
</html>
