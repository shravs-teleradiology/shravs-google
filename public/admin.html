<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Shravs Teleradiology</title>
  <style>
    *{ margin:0; padding:0; box-sizing:border-box; }
    body{ font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; background:#000; color:#fff; }

    .header{
      background:linear-gradient(135deg,#0a0a0a,#1a1a1a);
      border-bottom:2px solid #0ea5e9;
      padding:18px 22px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .header-left{ display:flex; align-items:center; gap:14px; }
    .logo{ width:58px; height:58px; border-radius:50%; border:2px solid #fff; object-fit:cover; }
    .header h1{ font-size:1.2em; text-transform:uppercase; letter-spacing:1.5px; }

    .logout-btn{
      padding:10px 18px; border-radius:20px;
      background:transparent; border:2px solid #ff6b6b; color:#ff6b6b;
      cursor:pointer; font-weight:900; text-transform:uppercase; letter-spacing:0.8px;
    }
    .logout-btn:hover{ background:#ff6b6b; color:#fff; }

    .container{ max-width:1400px; margin:0 auto; padding:22px 16px 40px; }

    .stats{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px; margin-bottom:18px;
    }
    .stat{
      background:linear-gradient(135deg,#0a0a0a,#1a1a1a);
      border:2px solid #0ea5e9; border-radius:14px;
      padding:18px; text-align:center;
    }
    .stat .num{ font-size:2.4em; font-weight:900; color:#0ea5e9; }
    .stat .lbl{ color:#999; text-transform:uppercase; letter-spacing:1px; font-size:0.85em; }

    .section{
      background:#0a0a0a;
      border:2px solid #333; border-radius:14px;
      padding:18px; margin-bottom:14px;
    }
    .section-header{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:2px solid #222; padding-bottom:10px; margin-bottom:12px;
    }
    .section-title{
      color:#0ea5e9; font-size:1.1em; font-weight:900;
      text-transform:uppercase; letter-spacing:1px;
    }
    .search{
      width:320px; max-width:100%;
      padding:10px 12px; border-radius:18px;
      border:1px solid #333; background:#000; color:#fff;
    }
    .search:focus{ outline:none; border-color:#0ea5e9; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 920px){ .grid2{ grid-template-columns:1fr; } }

    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 700px){ .form-row{ grid-template-columns:1fr; } }
    label{
      display:block; margin-bottom:6px; font-size:0.8em; color:#ddd;
      text-transform:uppercase; letter-spacing:0.6px; font-weight:800;
    }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px;
      background:#000; color:#fff; border:1px solid #333;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:#0ea5e9; }

    .btn{
      padding:10px 14px; border-radius:18px; cursor:pointer;
      font-weight:900; text-transform:uppercase; letter-spacing:0.6px;
      border:1px solid #0ea5e9; background:#0ea5e9; color:#000;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn-danger{ border-color:#ef4444; background:#ef4444; color:#fff; }
    .btn-ghost{ background:transparent; color:#0ea5e9; }
    .btn-ghost:hover{ background:#0ea5e9; color:#000; }

    table{ width:100%; border-collapse:collapse; }
    th{
      text-align:left; color:#0ea5e9;
      padding:12px 10px; border-bottom:2px solid #0ea5e9;
      font-size:0.85em; text-transform:uppercase; letter-spacing:0.8px;
    }
    td{
      padding:12px 10px; border-bottom:1px solid #222; color:#ddd;
      vertical-align:top; font-size:0.92em;
    }
    tr:hover{ background:rgba(14,165,233,0.05); }
    .pill{
      display:inline-block; padding:4px 10px; border-radius:15px;
      font-size:0.8em; font-weight:900; text-transform:uppercase;
    }
    .pill.priority-high{ background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid #ef4444; }
    .pill.priority-medium{ background:rgba(245,158,11,0.2); color:#f59e0b; border:1px solid #f59e0b; }
    .pill.priority-low{ background:rgba(34,197,94,0.2); color:#22c55e; border:1px solid #22c55e; }
    .pill.pending{ background:rgba(251,191,36,0.2); color:#fbba24; border:1px solid #fbba24; }
    .pill.done{ background:rgba(74,222,128,0.2); color:#4ade80; border:1px solid #4ade80; }
    .muted{ color:#888; font-size:0.9em; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Chat button */
    .chat-btn{
      padding:10px 14px; border-radius:18px;
      background:linear-gradient(135deg,#0ea5e9,#06b6d4);
      color:#fff; border:none;
      font-weight:900; text-transform:uppercase; letter-spacing:0.6px;
      cursor:pointer;
    }
    .chat-btn:hover{ filter:brightness(1.08); }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <img class="logo" src="https://i.ibb.co/FL6BLkS/P-Untitled-design.png" alt="Logo"/>
      <h1>Admin Dashboard</h1>
    </div>
    <div style="display:flex; gap:12px;">
      <button class="chat-btn" onclick="openChat()">ðŸ’¬ Chat</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="stats">
      <div class="stat">
        <div class="num" id="statUsers">0</div>
        <div class="lbl">Total Users</div>
      </div>
      <div class="stat">
        <div class="num" id="statEmployees">0</div>
        <div class="lbl">Employees</div>
      </div>
      <div class="stat">
        <div class="num" id="statTasks">0</div>
        <div class="lbl">Total Tasks</div>
      </div>
      <div class="stat">
        <div class="num" id="statPending">0</div>
        <div class="lbl">Pending Tasks</div>
      </div>
    </div>

    <div class="grid2">
      <!-- Employee Management -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Create Employee</div>
        </div>

        <div class="form-row">
          <div>
            <label for="empName">Name</label>
            <input id="empName" placeholder="Employee name"/>
          </div>
          <div>
            <label for="empEmail">Email</label>
            <input id="empEmail" type="email" placeholder="employee@example.com"/>
          </div>
          <div>
            <label for="empOrg">Department/Location</label>
            <input id="empOrg" placeholder="Department or location"/>
          </div>
          <div>
            <label for="empPassword">Password</label>
            <input id="empPassword" placeholder="Set password"/>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="createEmployee()">Create Employee</button>
          <div class="muted" style="margin-top:8px;">Employees cannot sign up from login page.</div>
        </div>
      </div>

      <!-- Assign Work -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Assign Work</div>
        </div>

        <div class="form-row">
          <div>
            <label for="taskAssignee">Assign to</label>
            <select id="taskAssignee"></select>
          </div>
          <div>
            <label for="taskPriority">Priority</label>
            <select id="taskPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label for="taskDue">Due date</label>
            <input id="taskDue" type="date"/>
          </div>
          <div style="grid-column:1/-1;">
            <label for="taskTitle">Title</label>
            <input id="taskTitle" placeholder="Work title"/>
          </div>
          <div style="grid-column:1/-1;">
            <label for="taskDesc">Description</label>
            <textarea id="taskDesc" placeholder="Work details..."></textarea>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" onclick="assignTask()">Assign Task</button>
          <div class="muted" style="margin-top:8px;">Employee sees tasks immediately after login.</div>
        </div>
      </div>
    </div>

    <!-- Employee List -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Employees</div>
        <input class="search" id="empSearch" placeholder="Search employee..." oninput="renderEmployees()"/>
      </div>
      <div id="employeesTable"></div>
    </div>

    <!-- Tasks -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Assigned Works</div>
        <input class="search" id="taskSearch" placeholder="Search tasks..." oninput="renderTasks()"/>
      </div>
      <div id="tasksTable"></div>
    </div>
  </div>

<script>
  if (sessionStorage.getItem("isAdmin") !== "true") {
    alert("Unauthorized access. Please login as admin.");
    window.location.href = "login.html";
  }

  const TASKS_KEY = "tasks_v1";

  function readJson(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || "null") ?? fallback; }
    catch { return fallback; }
  }
  function writeJson(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function logout(){
    if (!confirm("Logout?")) return;
    sessionStorage.clear();
    window.location.href = "login.html";
  }

  function getUsers(){ return readJson("users", []); }
  function saveUsers(users){ writeJson("users", users); }

  function getEmployees(){
    return getUsers().filter(u => u.role === "employee");
  }

  function makeId(){
    return "t_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function getTasks(){ return readJson(TASKS_KEY, []); }
  function saveTasks(tasks){ writeJson(TASKS_KEY, tasks); }

  function refreshStats(){
    const users = getUsers();
    const employees = users.filter(u => u.role === "employee");
    const tasks = getTasks();
    const pending = tasks.filter(t => t.status === "pending").length;

    document.getElementById("statUsers").textContent = users.length;
    document.getElementById("statEmployees").textContent = employees.length;
    document.getElementById("statTasks").textContent = tasks.length;
    document.getElementById("statPending").textContent = pending;
  }

  function createEmployee(){
    const name = document.getElementById("empName").value.trim();
    const email = document.getElementById("empEmail").value.trim();
    const org = document.getElementById("empOrg").value.trim();
    const pw = document.getElementById("empPassword").value.trim();

    if (!name || !email || !pw) { alert("Name, email, password required."); return; }

    const users = getUsers();
    if (users.some(u => u.email === email)) { alert("Email already exists."); return; }

    users.push({
      name, email, phone:"", organization:org, role:"employee",
      password:pw, createdAt:new Date().toISOString()
    });
    saveUsers(users);

    document.getElementById("empName").value = "";
    document.getElementById("empEmail").value = "";
    document.getElementById("empOrg").value = "";
    document.getElementById("empPassword").value = "";

    alert("Employee created successfully.");
    populateAssigneeDropdown();
    renderEmployees();
    refreshStats();
  }

  function populateAssigneeDropdown(){
    const sel = document.getElementById("taskAssignee");
    const employees = getEmployees();
    if (!employees.length) {
      sel.innerHTML = `<option value="">No employees found</option>`;
      return;
    }
    sel.innerHTML = `<option value="">-- Select employee --</option>` +
      employees.map(e => `<option value="${escapeHtml(e.email)}">${escapeHtml(e.name)} (${escapeHtml(e.email)})</option>`).join("");
  }

  function assignTask(){
    const assigneeEmail = document.getElementById("taskAssignee").value;
    const priority = document.getElementById("taskPriority").value;
    const due = document.getElementById("taskDue").value;
    const title = document.getElementById("taskTitle").value.trim();
    const desc = document.getElementById("taskDesc").value.trim();

    if (!assigneeEmail || !title) { alert("Assignee and title are required."); return; }

    const employees = getEmployees();
    const emp = employees.find(e => e.email === assigneeEmail);
    if (!emp) { alert("Selected assignee is not an employee."); return; }

    const tasks = getTasks();
    tasks.push({
      id: makeId(),
      title,
      description: desc,
      priority, // "high" | "medium" | "low"
      assignedToEmail: emp.email,
      assignedToName: emp.name,
      dueDate: due || "",
      status: "pending",
      createdAt: new Date().toISOString(),
      createdBy: "admin"
    });
    saveTasks(tasks);

    document.getElementById("taskTitle").value = "";
    document.getElementById("taskDesc").value = "";
    document.getElementById("taskDue").value = "";

    alert("Task assigned successfully.");
    renderTasks();
    refreshStats();
  }

  function toggleTaskStatus(taskId){
    const tasks = getTasks();
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;
    t.status = (t.status === "pending") ? "done" : "pending";
    saveTasks(tasks);
    renderTasks();
    refreshStats();
  }

  function deleteTask(taskId){
    if (!confirm("Delete this task?")) return;
    const tasks = getTasks().filter(t => t.id !== taskId);
    saveTasks(tasks);
    renderTasks();
    refreshStats();
  }

  function renderEmployees(){
    const q = (document.getElementById("empSearch").value || "").toLowerCase();
    const employees = getEmployees().filter(e =>
      (e.name || "").toLowerCase().includes(q) ||
      (e.email || "").toLowerCase().includes(q) ||
      (e.organization || "").toLowerCase().includes(q)
    );

    const box = document.getElementById("employeesTable");
    if (!employees.length) {
      box.innerHTML = `<div class="muted">No employees.</div>`;
      return;
    }

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Department</th><th>Created</th>
          </tr>
        </thead>
        <tbody>
          ${employees.map(e => `
            <tr>
              <td>${escapeHtml(e.name)}</td>
              <td>${escapeHtml(e.email)}</td>
              <td>${escapeHtml(e.organization || "-")}</td>
              <td>${new Date(e.createdAt).toLocaleDateString()}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderTasks(){
    const q = (document.getElementById("taskSearch").value || "").toLowerCase();
    let tasks = getTasks();

    tasks = tasks.filter(t =>
      (t.title || "").toLowerCase().includes(q) ||
      (t.description || "").toLowerCase().includes(q) ||
      (t.assignedToName || "").toLowerCase().includes(q) ||
      (t.assignedToEmail || "").toLowerCase().includes(q) ||
      (t.priority || "").toLowerCase().includes(q)
    );

    tasks.sort((a,b) => {
      // Priority: high > medium > low
      const prio = {high:3, medium:2, low:1};
      const aPrio = prio[a.priority || "low"] || 1;
      const bPrio = prio[b.priority || "low"] || 1;
      if (aPrio !== bPrio) return bPrio - aPrio;
      return new Date(b.createdAt) - new Date(a.createdAt);
    });

    const box = document.getElementById("tasksTable");
    if (!tasks.length) {
      box.innerHTML = `<div class="muted">No tasks assigned.</div>`;
      return;
    }

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Priority</th><th>Status</th><th>Title</th><th>Assigned To</th><th>Due</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${tasks.map(t => `
            <tr>
              <td><span class="pill priority-${escapeHtml(t.priority || 'low')}">${escapeHtml(t.priority || 'low')}</span></td>
              <td><span class="pill ${escapeHtml(t.status)}">${escapeHtml(t.status)}</span></td>
              <td>
                <div style="font-weight:900;">${escapeHtml(t.title)}</div>
                <div class="muted" style="margin-top:4px; white-space:pre-wrap;">${escapeHtml(t.description || "")}</div>
              </td>
              <td>${escapeHtml(t.assignedToName)}<div class="muted">${escapeHtml(t.assignedToEmail)}</div></td>
              <td>${t.dueDate ? escapeHtml(t.dueDate) : "-"}</td>
              <td>
                <div class="actions">
                  <button class="btn btn-ghost" onclick="toggleTaskStatus('${escapeHtml(t.id)}')">
                    ${t.status === "pending" ? "Mark done" : "Mark pending"}
                  </button>
                  <button class="btn btn-danger" onclick="deleteTask('${escapeHtml(t.id)}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function escapeHtml(text){
    return String(text ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // ===== CHAT FOR ADMIN (like employee) =====
  const COMMON_KEY = "commonChatMessages_v1";

  function openChat() {
    const admin = { name: "Admin", email: "admin@shravsteleradiology.com", role: "admin" };
    sessionStorage.setItem("currentUser", JSON.stringify(admin));
    sessionStorage.setItem("isLoggedIn", "true"); // fake employee session for chat
    window.open("employee.html", "_blank");
  }

  // ===== Init =====
  window.addEventListener("load", () => {
    populateAssigneeDropdown();
    renderEmployees();
    renderTasks();
    refreshStats();
    setInterval(() => { renderTasks(); refreshStats(); }, 15000);
  });
</script>
</body>
</html>
