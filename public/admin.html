<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Shravs</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,sans-serif;background:#fff;color:#111827}
    .header{
      background:linear-gradient(135deg,#fff,#fff5f5);
      border-bottom:2px solid #ef4444;
      padding:14px 22px;display:flex;justify-content:space-between;align-items:center;
      position:sticky;top:0;z-index:100;
    }
    .header-left{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:50%;border:2px solid #ef4444;object-fit:cover;background:#fff}
    .header-title{font-size:1.2em;font-weight:900;color:#b91c1c}
    .container{max-width:1400px;margin:26px auto;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:18px}
    @media (max-width: 900px){.container{grid-template-columns:1fr}}
    .card{
      background:#ffffff;border:1px solid #fee2e2;border-radius:16px;padding:22px;
      box-shadow:0 10px 25px rgba(239,68,68,.10);transition:.2s;
    }
    .card:hover{border-color:#ef4444}
    .card.full-width{grid-column:1 / -1}
    h2{color:#b91c1c;margin-bottom:14px;font-size:1.15em;text-transform:uppercase;letter-spacing:.5px}
    label{display:block;color:#b91c1c;font-weight:800;margin-top:10px;font-size:.86em;text-transform:uppercase}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;
      margin:8px 0;font-size:.95em
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.14)}
    button{
      background:linear-gradient(135deg,#ef4444,#b91c1c);
      color:#fff;border:none;padding:12px 18px;border-radius:999px;cursor:pointer;font-weight:900;margin:6px 0;
      text-transform:uppercase;font-size:.85em;letter-spacing:.4px
    }
    button:hover{filter:brightness(.98)}
    button.btn-full{width:100%;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{text-align:left;padding:10px;border-bottom:1px solid #f3f4f6}
    th{color:#b91c1c;font-size:.82em;text-transform:uppercase}
    td{color:#374151}
    .empty-state{text-align:center;padding:26px 10px;color:#6b7280}
    .success-msg{background:#ecfdf5;color:#047857;padding:10px;border-radius:10px;margin-bottom:10px;font-weight:800;display:none;border:1px solid #10b981}
    .success-msg.show{display:block}
    .note{background:#fff5f5;border-left:3px solid #ef4444;padding:10px;border-radius:10px;color:#6b7280;font-size:.9em;margin-top:8px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <a href="index.html"><img src="logo.jpg" alt="Shravs Logo" class="logo" onerror="this.style.display='none'"></a>
      <div class="header-title">Admin Dashboard</div>
    </div>
    <div><button onclick="logout()">Logout</button></div>
  </div>

  <div class="container">

    <!-- 1. CREATE NEW EMPLOYEE -->
    <div class="card">
      <h2>Create New Employee</h2>
      <div class="success-msg" id="createEmployeeSuccess">Employee created successfully!</div>
      <form id="createEmployeeForm">
        <label>Full Name *</label>
        <input type="text" id="empName" required placeholder="Employee name">

        <label>Email *</label>
        <input type="email" id="empEmail" required placeholder="employee@example.com">

        <label>Temporary Password *</label>
        <input type="password" id="empPassword" required placeholder="Temporary password">

        <div class="note">Employee will be asked to change password on first login</div>
        <button type="submit" class="btn-full">Create Employee</button>
      </form>
    </div>

    <!-- 2. ASSIGN TASK -->
    <div class="card">
      <h2>Assign Task</h2>
      <div class="success-msg" id="assignTaskSuccess">Task assigned successfully!</div>
      <form id="assignTaskForm">
        <label>Select Employee *</label>
        <select id="taskEmployee" required>
          <option value="">Loading employees...</option>
        </select>

        <label>Task Title *</label>
        <input type="text" id="taskTitle" required placeholder="Task title">

        <label>Description</label>
        <textarea id="taskDescription" rows="3" placeholder="Task details"></textarea>

        <label>Priority *</label>
        <select id="taskPriority" required>
          <option value="high">High</option>
          <option value="medium" selected>Medium</option>
          <option value="low">Low</option>
        </select>

        <label>Due Date</label>
        <input type="date" id="taskDueDate">

        <button type="submit" class="btn-full">Assign Task</button>
      </form>
    </div>

    <!-- 3. PROMOTE EMPLOYEE -->
    <div class="card">
      <h2>Promote Employee</h2>
      <label>Select Employee</label>
      <select id="promoteEmployee">
        <option value="">Loading employees...</option>
      </select>
      <button onclick="promoteToAdmin()" class="btn-full">Promote to Admin</button>
    </div>

    <!-- 4. ALL EMPLOYEES -->
    <div class="card">
      <h2>All Employees</h2>
      <div id="employeesList"><div class="empty-state">Loading...</div></div>
    </div>

    <!-- 5. ALL QUERIES -->
    <div class="card full-width">
      <h2>Signup / User Queries</h2>
      <div id="allQueries"><div class="empty-state">Loading...</div></div>
    </div>

  </div>

  <script type="module">
    import { logout as apiLogout } from './api.js';

    window.logout = apiLogout;

    async function loadEmployees() {
      try {
        const res = await fetch(`/api/team?role=employee`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await res.json().catch(() => null);
        const employees = Array.isArray(data) ? data : (data?.items || []);

        const taskSelect = document.getElementById('taskEmployee');
        const promoteSelect = document.getElementById('promoteEmployee');

        const options = employees.map(e =>
          `<option value="${e.id}">${(e.name||'No Name')} (${e.email||''})</option>`
        ).join('');

        taskSelect.innerHTML = `<option value="">-- Select Employee --</option>${options}`;
        promoteSelect.innerHTML = `<option value="">-- Select Employee --</option>${options}`;

        const listContainer = document.getElementById('employeesList');
        if (!employees.length) {
          listContainer.innerHTML = `<div class="empty-state">No employees found.</div>`;
          return;
        }

        let html = `<table><tr><th>Name</th><th>Email</th><th>Joined</th></tr>`;
        employees.forEach(e => {
          const joined = e.created_at ? new Date(e.created_at).toLocaleDateString() : '';
          html += `<tr><td>${e.name||''}</td><td>${e.email||''}</td><td>${joined}</td></tr>`;
        });
        html += `</table>`;
        listContainer.innerHTML = html;
      } catch (e) {
        document.getElementById('employeesList').innerHTML =
          `<div class="empty-state">Failed to load employees. Please login again.</div>`;
      }
    }

    // CREATE EMPLOYEE
    document.getElementById('createEmployeeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const employeeData = {
        name: document.getElementById('empName').value.trim(),
        email: document.getElementById('empEmail').value.trim(),
        password: document.getElementById('empPassword').value
      };

      try {
        const res = await fetch(`/api/admin-create-employee`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(employeeData)
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(out.error || out.message || 'Failed');

        document.getElementById('createEmployeeSuccess').classList.add('show');
        document.getElementById('createEmployeeForm').reset();
        setTimeout(() => document.getElementById('createEmployeeSuccess').classList.remove('show'), 2500);
        loadEmployees();
      } catch (err) {
        alert('Failed to create employee: ' + err.message);
      }
    });

    // ASSIGN TASK
    document.getElementById('assignTaskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const employeeId = document.getElementById('taskEmployee').value;
      if (!employeeId) return alert('Select an employee');

      const payload = {
        assignedto: employeeId,
        title: document.getElementById('taskTitle').value.trim(),
        description: document.getElementById('taskDescription').value.trim(),
        priority: document.getElementById('taskPriority').value,
        duedate: document.getElementById('taskDueDate').value || null,
        status: 'pending'
      };

      try {
        const res = await fetch(`/api/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(payload)
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(out.error || out.message || 'Failed');

        document.getElementById('assignTaskSuccess').classList.add('show');
        document.getElementById('assignTaskForm').reset();
        setTimeout(() => document.getElementById('assignTaskSuccess').classList.remove('show'), 2500);
      } catch (err) {
        alert('Failed to assign task: ' + err.message);
      }
    });

    // PROMOTE TO ADMIN
    window.promoteToAdmin = async () => {
      const userId = document.getElementById('promoteEmployee').value;
      if (!userId) return alert('Select an employee');
      if (!confirm('Promote this employee to admin?')) return;

      try {
        const res = await fetch(`/api/admin-set-role`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ userid: userId, role: 'admin' })
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(out.error || out.message || 'Failed');

        alert('Employee promoted to admin successfully!');
        loadEmployees();
      } catch (err) {
        alert('Promotion failed: ' + err.message);
      }
    };

    // LOAD QUERIES (localStorage)
    function loadQueries() {
      const queries = JSON.parse(localStorage.getItem('queries') || '[]');
      const container = document.getElementById('allQueries');

      if (!queries.length) {
        container.innerHTML = `<div class="empty-state">No queries yet.</div>`;
        return;
      }

      let html = `<table><tr><th>Type</th><th>Name</th><th>Email</th><th>Message</th><th>Date</th></tr>`;
      queries.slice().reverse().forEach(q => {
        const msg = (q.message || '').toString();
        const shortMsg = msg.length > 60 ? msg.substring(0, 60) + '...' : msg;
        const date = q.timestamp ? new Date(q.timestamp).toLocaleDateString() : '';
        html += `<tr>
          <td style="text-transform:capitalize">${q.type || ''}</td>
          <td>${q.name || ''}</td>
          <td>${q.email || ''}</td>
          <td>${shortMsg}</td>
          <td>${date}</td>
        </tr>`;
      });
      html += `</table>`;
      container.innerHTML = html;
    }

    // INIT
    loadEmployees();
    loadQueries();
    setInterval(loadQueries, 30000);
  </script>
</body>
</html>
